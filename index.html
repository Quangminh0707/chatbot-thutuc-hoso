<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTHC_Chatbot - Hệ thống tra cứu</title>
    <!-- Thư viện icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* CSS GIAO DIỆN TỔNG THỂ */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { display: flex; height: 100vh; background-color: #ffffff; overflow: hidden; }

        /* Sidebar bên trái giống ChatGPT */
        .sidebar { width: 260px; background-color: #f9f9f9; padding: 15px; border-right: 1px solid #e5e5e5; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-item { display: flex; align-items: center; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 14px; border: none; background: none; width: 100%; text-align: left; margin-bottom: 5px; transition: 0.2s; }
        .sidebar-item:hover { background-color: #ececec; }
        .sidebar-item i { margin-right: 12px; width: 20px; text-align: center; color: #676767; }

        /* Vùng nội dung chính bên phải */
        .main-container { flex: 1; display: flex; flex-direction: column; align-items: center; background-color: #fff; position: relative; }
        .top-nav { width: 100%; padding: 15px 25px; font-weight: 600; font-size: 18px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; }

        /* Khu vực giữa màn hình */
        .content-area { width: 100%; max-width: 850px; flex: 1; display: flex; flex-direction: column; align-items: center; padding: 20px; text-align: center; overflow-y: auto; }

        /* Tiêu đề dự án - LÀM NỔI BẬT THEO YÊU CẦU */
        .project-header { margin-top: 20px; margin-bottom: 30px; }
        .project-title { color: #1a73e8; font-size: 28px; font-weight: 800; text-transform: uppercase; margin-bottom: 15px; display: block; }
        .project-subtitle { font-size: 18px; color: #444; margin-bottom: 15px; font-weight: 500; }
        
        .procedure-box { text-align: left; background: #f8f9fa; padding: 20px 30px; border-radius: 15px; border: 1px solid #eee; width: 100%; max-width: 650px; line-height: 1.8; margin-bottom: 25px; }
        .procedure-box li { list-style: none; font-size: 16px; color: #333; }
        .procedure-box li i { color: #1a73e8; margin-right: 10px; }

        /* ============================================================ */
        /* PHẦN QUAN TRỌNG NHẤT: ÉP CHATBOT VÀO GIỮA & XÓA BONG BÓNG */
        /* ============================================================ */
        
        #chatbot-frame {
            width: 100%;
            max-width: 750px; /* Độ rộng khung chat */
            height: 500px;    /* Chiều cao khung chat */
            position: relative;
            border: 1px solid #e5e5e5;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            background: #fff;
        }

        /* 1. Ẩn nút bong bóng tròn (Launcher) */
        df-messenger::part(launcher) {
            display: none !important;
        }

        /* 2. Ép khung chat hiển thị trực tiếp, không bay lơ lửng */
        df-messenger::part(chat-wrapper) {
            position: static !important;
            height: 100% !important;
            width: 100% !important;
            bottom: unset !important;
            right: unset !important;
            box-shadow: none !important;
        }

        /* 3. Tùy chỉnh màu sắc bên trong bot */
        df-messenger {
            --df-messenger-button-titlebar-color: #f8f9fa;
            --df-messenger-send-icon: #1a73e8;
            --df-messenger-user-message: #e7f3ff;
            --df-messenger-font-color: #000;
            display: block;
            height: 100%;
        }
    </style>
</head>
<body>

    <!-- Sidebar giống ChatGPT -->
    <aside class="sidebar">
        <div style="margin-bottom: 20px; font-size: 20px; color: #676767;"><i class="fa-solid fa-bars"></i></div>
        
        <button class="sidebar-item" onclick="createNewChat()">
            <i class="fa-regular fa-message"></i> Đoạn chat mới
        </button>
        
        <button class="sidebar-item"><i class="fa-solid fa-magnifying-glass"></i> Tìm kiếm</button>
        <button class="sidebar-item"><i class="fa-regular fa-image"></i> Ảnh</button>
        <button class="sidebar-item"><i class="fa-solid fa-grid-2"></i> Ứng dụng</button>
    </aside>

    <main class="main-container">
        <!-- Thanh Nav trên cùng -->
        <header class="top-nav">
            <div>TTHC_Chatbot <i class="fa-solid fa-chevron-down" style="font-size: 12px; margin-left: 5px;"></i></div>
            <div style="color: #676767;"><i class="fa-solid fa-user-plus" style="margin-right: 15px;"></i><i class="fa-solid fa-circle-notch"></i></div>
        </header>

        <!-- Nội dung giữa màn hình -->
        <div class="content-area">
            <div class="project-header">
                <h1 class="project-title">DỰ ÁN CHATBOT TRA CỨU TTHC ĐƠN GIẢN</h1>
                <p class="project-subtitle">Chatbot đã sẵn sàng. Hãy thử hỏi về 3 thủ tục:</p>
            </div>

            <ul class="procedure-box">
                <li><i class="fa-solid fa-circle-check"></i> Quy định về Luật Hôn nhân & Gia đình</li>
                <li><i class="fa-solid fa-circle-check"></i> Quy định về Luật Căn cước mới nhất</li>
                <li><i class="fa-solid fa-circle-check"></i> Quy định về Luật Đất đai (Cấp lại sổ đỏ)</li>
            </ul>

            <!-- Khung chứa Chatbot -->
            <div id="chatbot-frame">
                <!-- Script và thẻ bot sẽ được chèn vào đây -->
            </div>
        </div>
    </main>

    <!-- Script Dialogflow -->
    <script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script>
    
    <script>
        // Hàm này sẽ xóa bot cũ và tạo bot mới hoàn toàn
        function createNewChat() {
            const frame = document.getElementById('chatbot-frame');
            frame.innerHTML = ''; // Xóa sạch nội dung cũ bên trong khung
            
            // Tạo thẻ chatbot mới
            const dfBot = document.createElement('df-messenger');
            
            // Cài đặt thông số của bạn từ ảnh Console
            dfBot.setAttribute('intent', 'WELCOME');
            dfBot.setAttribute('chat-title', 'TTHC_Chatbot_KHKT');
            dfBot.setAttribute('agent-id', 'beb30889-a174-4fd7-b494-b2a3fe16a795');
            dfBot.setAttribute('language-code', 'vi');
            dfBot.setAttribute('expand', 'true'); // Ép khung chat luôn mở
            
            // Chèn bot vào khung ở giữa
            frame.appendChild(dfBot);
        }

        // Tự động chạy khi vừa mở trang web
        window.onload = createNewChat;
    </script>

</body>
</html>
<!-- Thêm CSS cho nút Micro -->
<style>
    .voice-control {
        position: absolute;
        bottom: 20px;
        right: 80px; /* Nằm cạnh khung nhập liệu của bot */
        z-index: 999;
    }
    #mic-btn {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        border: none;
        background: #1a73e8;
        color: white;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        transition: 0.3s;
    }
    #mic-btn.recording {
        background: #ea4335;
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
</style>

<!-- Chèn nút Micro vào bên trong #chatbot-frame -->
<div id="chatbot-frame">
    <div class="voice-control">
        <button id="mic-btn" title="Nói bằng tiếng Việt"><i class="fa-solid fa-microphone"></i></button>
    </div>
    <!-- df-messenger sẽ được script chèn vào đây -->
</div>

<script>
    const frame = document.getElementById('chatbot-frame');
    let dfBot;

    // 1. Khởi tạo Bot
    function createNewChat() {
        // Xóa bot cũ nếu có (giữ lại nút mic)
        const oldBot = document.querySelector('df-messenger');
        if (oldBot) oldBot.remove();
        
        dfBot = document.createElement('df-messenger');
        dfBot.setAttribute('intent', 'WELCOME');
        dfBot.setAttribute('chat-title', 'TTHC_Chatbot_KHKT');
        dfBot.setAttribute('agent-id', 'beb30889-a174-4fd7-b494-b2a3fe16a795');
        dfBot.setAttribute('language-code', 'vi');
        dfBot.setAttribute('expand', 'true');
        
        frame.appendChild(dfBot);

        // Lắng nghe sự kiện bot trả lời để đọc lên
        dfBot.addEventListener('df-response-received', function (event) {
            const speechText = event.detail.response.queryResult.fulfillmentText;
            speak(speechText);
        });
    }

    window.onload = createNewChat;

    // 2. Xử lý Chuyển giọng nói thành văn bản (STT)
    const micBtn = document.getElementById('mic-btn');
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (SpeechRecognition) {
        const recognition = new SpeechRecognition();
        recognition.lang = 'vi-VN'; // Thiết lập tiếng Việt
        recognition.interimResults = false;

        micBtn.addEventListener('click', () => {
            recognition.start();
            micBtn.classList.add('recording');
        });

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            console.log("Bạn đã nói: ", transcript);
            
            // Gửi văn bản này vào Dialogflow
            const messenger = document.querySelector('df-messenger');
            messenger.renderCustomText(transcript); // Hiển thị tin nhắn của bạn lên màn hình
            messenger.sendQuery(transcript);      // Gửi thực sự tới server
            
            micBtn.classList.remove('recording');
        };

        recognition.onspeechend = () => {
            recognition.stop();
            micBtn.classList.remove('recording');
        };

        recognition.onerror = (event) => {
            console.error("Lỗi nhận diện: ", event.error);
            micBtn.classList.remove('recording');
        };
    } else {
        alert("Trình duyệt của bạn không hỗ trợ nhận diện giọng nói.");
    }

    // 3. Xử lý Chuyển văn bản thành giọng nói (TTS)
    function speak(text) {
        // Ngừng các giọng đang nói dở
        window.speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'vi-VN';
        
        // Tìm giọng tiếng Việt trong hệ thống
        const voices = window.speechSynthesis.getVoices();
        const viVoice = voices.find(v => v.lang.includes('vi'));
        if (viVoice) utterance.voice = viVoice;

        utterance.rate = 1.0; // Tốc độ nói
        window.speechSynthesis.speak(utterance);
    }
</script>

